import{j as e,f,y as m,k as R,c as S,u as D,b as g,L as $,i as I}from"./index-Cq2iuTYL.js";const E=()=>new Promise((t,i)=>{if(window.Razorpay)return t(!0);const l=document.querySelector('script[src="https://checkout.razorpay.com/v1/checkout.js"]');if(l){l.addEventListener("load",()=>t(!0)),l.addEventListener("error",()=>i(new Error("Razorpay script failed to load")));return}const s=document.createElement("script");s.src="https://checkout.razorpay.com/v1/checkout.js",s.async=!0,s.onload=()=>t(!0),s.onerror=()=>i(new Error("Razorpay script failed to load")),document.body.appendChild(s)}),L=({amount:t,currency:i="INR",onSuccess:l,onError:s,meta:d,disabled:r=!1,onDisabledClick:b})=>{const y=async()=>{var j,N,w,x,v,p,z;if(r){b==null||b();return}try{if(await E(),!window.Razorpay)throw new Error("Razorpay checkout not available");const a=await f.post("/payment/create-order",{amount:t,currency:i,meta:d},{withCredentials:!0}),c=a.data.order||a.data,u=((j=a.data)==null?void 0:j.key_id)||c.key_id||void 0;if(!u){console.error("Razorpay: missing key_id",{orderRes:a,order:c}),m.error("Payment configuration error: missing Razorpay key. Contact support.");return}if(!c||!c.amount){console.error("Razorpay: invalid order response",{orderRes:a,order:c}),m.error("Payment initialization failed: invalid order from server.");return}const o={key:u,amount:c.amount,currency:c.currency,name:"Quickzy",description:"Order Payment",order_id:c.id,handler:async function(n){try{await f.post("/payment/verify",{razorpay_order_id:n.razorpay_order_id,razorpay_payment_id:n.razorpay_payment_id,razorpay_signature:n.razorpay_signature},{withCredentials:!0}),l&&l(n)}catch(h){s&&s(h)}},prefill:{name:((N=d==null?void 0:d.customer)==null?void 0:N.name)||"",email:((w=d==null?void 0:d.customer)==null?void 0:w.email)||"",contact:((x=d==null?void 0:d.customer)==null?void 0:x.phone)||""},theme:{color:"black"}};try{const n=new window.Razorpay(o);n.on("payment.failed",function(h){s&&s(h)}),n.open()}catch(n){console.error("Razorpay open error",n),m.error("Unable to open payment window. Try disabling browser extensions (adblock) or use another browser."),s&&s(n)}}catch(a){console.error("Razorpay error:",a),a!=null&&a.response&&console.error("Server response:",a.response.status,a.response.data);const c=(v=a==null?void 0:a.response)==null?void 0:v.status,u=((z=(p=a==null?void 0:a.response)==null?void 0:p.data)==null?void 0:z.error)||(a==null?void 0:a.message)||"Payment initialization failed";u.includes("Razorpay script failed to load")||u.toLowerCase().includes("checkout not available")?m.error("Payment unavailable — your browser or an extension may be blocking Razorpay. Disable adblocker or try another browser."):m.error(`Payment error${c?" ("+c+")":""}: ${u}`),s&&s(a)}};return e.jsx("button",{onClick:y,disabled:r,className:`w-full py-4 rounded-2xl text-lg font-bold transition-all duration-200 ${r?"bg-gray-300 text-gray-600 cursor-not-allowed opacity-60":"bg-black text-white hover:bg-zinc-900 active:scale-95 cursor-pointer"}`,title:r?"Please complete your profile details first":"Proceed to payment",children:r?"⚠ Complete Your Details":`Confirm & Pay ₹${t}`})},V=t=>{if(!t)return{isValid:!1,missingFields:["User not found"]};const i=[];return(!t.address||t.address.trim()==="")&&i.push("Address"),!t.mobile&&!t.phone&&i.push("Contact Number"),(!t.zipCode||t.zipCode.trim()==="")&&i.push("Pincode"),(!t.state||t.state.trim()==="")&&i.push("State"),{isValid:i.length===0,missingFields:i}},C=t=>t.length===0?"":t.length===1?`Please complete your ${t[0]} before proceeding with payment.`:`Please complete your ${t.slice(0,-1).join(", ")+" and "+t[t.length-1]} before proceeding with payment.`,q=()=>{var u;const{id:t}=R(),i=S(),l=D(),[s,d]=g.useState(null),[r,b]=g.useState(null),[y,j]=g.useState(Number.isInteger((u=i.state)==null?void 0:u.quantity)&&i.state.quantity>0?i.state.quantity:1),[N,w]=g.useState(!1),[x,v]=g.useState({isValid:!1,missingFields:[]}),p=s?(s.price*y).toFixed(2):"0.00";g.useEffect(()=>{f.get(`/products/${t}`).then(o=>d(o.data)).catch(()=>m.error("Failed to load product"))},[t]),g.useEffect(()=>{f.get("/profile",{withCredentials:!0}).then(o=>{const n=o.data.user||o.data;b(n);const h=V(n);v(h)}).catch(()=>{m.error("Please log in first"),l("/login")})},[l]);const z=async o=>{var n;w(!0);try{await f.post("/cart/create",{productId:t,quantity:y,customer:{name:r.username,address:r.address,phone:r.mobile},total:Number(p),payment:{razorpay_order_id:o.razorpay_order_id,razorpay_payment_id:o.razorpay_payment_id,razorpay_signature:o.razorpay_signature}},{withCredentials:!0});const _=(n=(await f.post("/cart/create",{productId:t,quantity:y,customer:{name:r.username,address:r.address,phone:r.mobile},total:Number(p),payment:{razorpay_order_id:o.razorpay_order_id,razorpay_payment_id:o.razorpay_payment_id,razorpay_signature:o.razorpay_signature}},{withCredentials:!0})).data)==null?void 0:n.order;let k="Payment successful!";if(_&&_.expectedDeliveryDate){const P=new Date(_.expectedDeliveryDate);k+=` Estimated delivery: ${P.toDateString()} (Quickzy)`}else{const P=new Date(Date.now()+2592e5);k+=` Estimated delivery: ${P.toDateString()} (Quickzy)`}m.success(k),setTimeout(()=>l("/orders"),1400)}catch{m.error("Order save failed")}finally{w(!1)}},a=()=>{const o=C(x.missingFields);m.error(o),setTimeout(()=>{l("/profile")},2e3)},c=()=>{m.error("Payment failed or cancelled.")};return!s||!r?e.jsx("div",{className:"min-h-screen flex justify-center items-center bg-gray-50",children:e.jsx($,{text:"Loading checkout..."})}):e.jsxs("div",{className:"min-h-screen bg-gray-50 py-10 px-4",children:[e.jsx(I,{position:"top-right",autoClose:2500}),e.jsxs("div",{className:"max-w-5xl mx-auto space-y-8",children:[e.jsxs("div",{className:"text-left",children:[e.jsx("button",{onClick:()=>l(-1),className:"text-gray-500 hover:text-black text-sm mb-4",children:"← Back"}),e.jsx("h1",{className:"text-3xl font-medium text-zinc-950",children:" Final Checkout"}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:"Complete your purchase securely"})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-xl p-6 shadow-sm border",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Order Summary"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-6",children:[e.jsx("img",{src:Array.isArray(s.images)&&s.images[0]||s.image,alt:s.title,className:"w-40 h-40 object-cover rounded-lg shadow-md"}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900",children:s.title}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-gray-600 text-sm",children:"Quantity:"}),e.jsxs("div",{className:"flex items-center border rounded-xl overflow-hidden bg-gray-50",children:[e.jsx("button",{className:"px-3 py-1 text-lg hover:bg-gray-200 active:scale-95 transition",onClick:()=>j(o=>Math.max(1,o-1)),children:"−"}),e.jsx("div",{className:"px-4 font-medium",children:y}),e.jsx("button",{className:"px-3 py-1 text-lg hover:bg-gray-200 active:scale-95 transition",onClick:()=>{if(y>=10){m.warn("Maximum 10 items allowed");return}j(o=>o+1)},children:"+"})]})]}),e.jsxs("p",{className:"text-xl font-semibold text-gray-900",children:["Total: ₹",p]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl p-6 shadow-sm border",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Delivery Info"}),e.jsx("button",{onClick:()=>l("/profile"),className:"text-sm text-zinc-950 hover:underline",children:"Edit"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-gray-700",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Name:"})," ",r.username]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Phone:"})," ",r.mobile]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",r.email]}),e.jsxs("p",{className:"sm:col-span-2",children:[e.jsx("strong",{children:"Address:"})," ",`${r.address}, ${r.city}, ${r.state} ${r.zipCode}`]})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-xl p-6 shadow-sm border",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Order Total"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal"}),e.jsxs("span",{className:"font-semibold",children:["₹",p]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Shipping"}),e.jsx("span",{className:"text-green-600 font-semibold",children:"Free"})]}),e.jsxs("div",{className:"flex justify-between border-t pt-3 mt-3",children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"Total"}),e.jsxs("span",{className:"text-2xl font-bold text-gray-900",children:["₹",p]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl p-6 shadow-sm border",children:[!x.isValid&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-red-700",children:[e.jsx("strong",{children:"Complete Your Profile:"})," ",C(x.missingFields)]})}),e.jsx(L,{amount:Number(p),currency:"INR",meta:{productId:t,quantity:y,customer:{name:r.username,address:r.address,phone:r.mobile}},onSuccess:z,onError:c,disabled:N||!x.isValid,onDisabledClick:x.isValid?null:a}),e.jsx("p",{className:"text-xs text-gray-500 text-center mt-3",children:"Secured by Razorpay"})]})]})]})]})]})};export{q as default};
