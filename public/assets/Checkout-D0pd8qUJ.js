import{j as e,f as h,y as l,k as _,c as k,u as R,b as x,L as C,i as P}from"./index-C3cbDq9_.js";const S=()=>new Promise((n,y)=>{if(window.Razorpay)return n(!0);const i=document.querySelector('script[src="https://checkout.razorpay.com/v1/checkout.js"]');if(i){i.addEventListener("load",()=>n(!0)),i.addEventListener("error",()=>y(new Error("Razorpay script failed to load")));return}const s=document.createElement("script");s.src="https://checkout.razorpay.com/v1/checkout.js",s.async=!0,s.onload=()=>n(!0),s.onerror=()=>y(new Error("Razorpay script failed to load")),document.body.appendChild(s)}),D=({amount:n,currency:y="INR",onSuccess:i,onError:s,meta:c,disabled:r=!1})=>{const N=async()=>{var d,g,b,f,m,j,w;if(!r)try{if(await S(),!window.Razorpay)throw new Error("Razorpay checkout not available");const t=await h.post("/payment/create-order",{amount:n,currency:y,meta:c},{withCredentials:!0}),a=t.data.order||t.data,u=((d=t.data)==null?void 0:d.key_id)||a.key_id||void 0;if(!u){console.error("Razorpay: missing key_id",{orderRes:t,order:a}),l.error("Payment configuration error: missing Razorpay key. Contact support.");return}if(!a||!a.amount){console.error("Razorpay: invalid order response",{orderRes:t,order:a}),l.error("Payment initialization failed: invalid order from server.");return}const v={key:u,amount:a.amount,currency:a.currency,name:"Quickzy",description:"Order Payment",order_id:a.id,handler:async function(o){try{await h.post("/payment/verify",{razorpay_order_id:o.razorpay_order_id,razorpay_payment_id:o.razorpay_payment_id,razorpay_signature:o.razorpay_signature},{withCredentials:!0}),i&&i(o)}catch(p){s&&s(p)}},prefill:{name:((g=c==null?void 0:c.customer)==null?void 0:g.name)||"",email:((b=c==null?void 0:c.customer)==null?void 0:b.email)||"",contact:((f=c==null?void 0:c.customer)==null?void 0:f.phone)||""},theme:{color:"black"}};try{const o=new window.Razorpay(v);o.on("payment.failed",function(p){s&&s(p)}),o.open()}catch(o){console.error("Razorpay open error",o),l.error("Unable to open payment window. Try disabling browser extensions (adblock) or use another browser."),s&&s(o)}}catch(t){console.error("Razorpay error:",t),t!=null&&t.response&&console.error("Server response:",t.response.status,t.response.data);const a=(m=t==null?void 0:t.response)==null?void 0:m.status,u=((w=(j=t==null?void 0:t.response)==null?void 0:j.data)==null?void 0:w.error)||(t==null?void 0:t.message)||"Payment initialization failed";u.includes("Razorpay script failed to load")||u.toLowerCase().includes("checkout not available")?l.error("Payment unavailable — your browser or an extension may be blocking Razorpay. Disable adblocker or try another browser."):l.error(`Payment error${a?" ("+a+")":""}: ${u}`),s&&s(t)}};return e.jsx("button",{onClick:N,disabled:r,className:`w-full py-4 rounded-2xl text-lg font-bold ${r?"bg-gray-400 text-gray-700":"bg-black text-white hover:bg-zinc-900"}`,children:r?"Processing...":`Confirm & Pay ₹${n}`})},E=()=>{var t;const{id:n}=_(),y=k(),i=R(),[s,c]=x.useState(null),[r,N]=x.useState(null),[d,g]=x.useState(Number.isInteger((t=y.state)==null?void 0:t.quantity)&&y.state.quantity>0?y.state.quantity:1),[b,f]=x.useState(!1),m=s?(s.price*d).toFixed(2):"0.00";x.useEffect(()=>{h.get(`/products/${n}`).then(a=>c(a.data)).catch(()=>l.error("Failed to load product"))},[n]),x.useEffect(()=>{h.get("/profile",{withCredentials:!0}).then(a=>N(a.data.user)).catch(()=>{l.error("Please log in first"),i("/login")})},[i]);const j=async a=>{var u;f(!0);try{await h.post("/cart/create",{productId:n,quantity:d,customer:{name:r.username,address:r.address,phone:r.mobile},total:Number(m),payment:{razorpay_order_id:a.razorpay_order_id,razorpay_payment_id:a.razorpay_payment_id,razorpay_signature:a.razorpay_signature}},{withCredentials:!0});const o=(u=(await h.post("/cart/create",{productId:n,quantity:d,customer:{name:r.username,address:r.address,phone:r.mobile},total:Number(m),payment:{razorpay_order_id:a.razorpay_order_id,razorpay_payment_id:a.razorpay_payment_id,razorpay_signature:a.razorpay_signature}},{withCredentials:!0})).data)==null?void 0:u.order;let p="Payment successful!";if(o&&o.expectedDeliveryDate){const z=new Date(o.expectedDeliveryDate);p+=` Estimated delivery: ${z.toDateString()} (Quickzy)`}else{const z=new Date(Date.now()+2592e5);p+=` Estimated delivery: ${z.toDateString()} (Quickzy)`}l.success(p),setTimeout(()=>i("/orders"),1400)}catch{l.error("Order save failed")}finally{f(!1)}},w=()=>{l.error("Payment failed or cancelled.")};return!s||!r?e.jsx("div",{className:"min-h-screen flex justify-center items-center bg-gray-50",children:e.jsx(C,{text:"Loading checkout..."})}):e.jsxs("div",{className:"min-h-screen bg-gray-50 py-10 px-4",children:[e.jsx(P,{position:"top-right",autoClose:2500}),e.jsxs("div",{className:"max-w-5xl mx-auto space-y-8",children:[e.jsxs("div",{className:"text-left",children:[e.jsx("button",{onClick:()=>i(-1),className:"text-gray-500 hover:text-black text-sm mb-4",children:"← Back"}),e.jsx("h1",{className:"text-3xl font-medium text-zinc-950",children:" Final Checkout"}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:"Complete your purchase securely"})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-xl p-6 shadow-sm border",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Order Summary"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-6",children:[e.jsx("img",{src:Array.isArray(s.images)&&s.images[0]||s.image,alt:s.title,className:"w-40 h-40 object-cover rounded-lg shadow-md"}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900",children:s.title}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-gray-600 text-sm",children:"Quantity:"}),e.jsxs("div",{className:"flex items-center border rounded-xl overflow-hidden bg-gray-50",children:[e.jsx("button",{className:"px-3 py-1 text-lg hover:bg-gray-200 active:scale-95 transition",onClick:()=>g(a=>Math.max(1,a-1)),children:"−"}),e.jsx("div",{className:"px-4 font-medium",children:d}),e.jsx("button",{className:"px-3 py-1 text-lg hover:bg-gray-200 active:scale-95 transition",onClick:()=>{if(d>=10){l.warn("Maximum 10 items allowed");return}g(a=>a+1)},children:"+"})]})]}),e.jsxs("p",{className:"text-xl font-semibold text-gray-900",children:["Total: ₹",m]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl p-6 shadow-sm border",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Delivery Info"}),e.jsx("button",{onClick:()=>i("/profile"),className:"text-sm text-zinc-950 hover:underline",children:"Edit"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-gray-700",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Name:"})," ",r.username]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Phone:"})," ",r.mobile]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",r.email]}),e.jsxs("p",{className:"sm:col-span-2",children:[e.jsx("strong",{children:"Address:"})," ",`${r.address}, ${r.city}, ${r.state} ${r.zipCode}`]})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-xl p-6 shadow-sm border",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Order Total"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal"}),e.jsxs("span",{className:"font-semibold",children:["₹",m]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Shipping"}),e.jsx("span",{className:"text-green-600 font-semibold",children:"Free"})]}),e.jsxs("div",{className:"flex justify-between border-t pt-3 mt-3",children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"Total"}),e.jsxs("span",{className:"text-2xl font-bold text-gray-900",children:["₹",m]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl p-6 shadow-sm border",children:[e.jsx(D,{amount:Number(m),currency:"INR",meta:{productId:n,quantity:d,customer:{name:r.username,address:r.address,phone:r.mobile}},onSuccess:j,onError:w,disabled:b}),e.jsx("p",{className:"text-xs text-gray-500 text-center mt-3",children:"Secured by Razorpay"})]})]})]})]})]})};export{E as default};
